

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Automatic parallelization of tasks &#8212; workflow  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'overview.parallelisation';</script>
    <link rel="shortcut icon" href="_static/wf_logo_final.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Functions as independently queued jobs" href="overview.queued.html" />
    <link rel="prev" title="Input and output of atomic structures" href="overview.configset.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/wf_logo_final.png" class="logo__image only-light" alt="workflow  documentation - Home"/>
    <script>document.write(`<img src="_static/wf_logo_final.png" class="logo__image only-dark" alt="workflow  documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="first_example.html">First Example</a></li>

<li class="toctree-l1 current active has-children"><a class="reference internal" href="overview.html">Overview</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.overall_design.html">Overall design</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.configset.html">Input and output of atomic structures</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Automatic parallelization of tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.queued.html">Functions as independently queued jobs</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="operations.html">Operations</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="operations.calculators.html">Calculators in Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="operations.generate.html">Generating Atomic Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="operations.descriptors.html">Descriptors</a></li>
<li class="toctree-l2"><a class="reference internal" href="operations.select.html">Selecting Configs</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="operations.fitting.html">Fitting potentials</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="operations.gap_fitting.html">Fitting GAP</a></li>
<li class="toctree-l3"><a class="reference internal" href="operations.multistage_gap_fitting.html">Multistage GAP fitting</a></li>
<li class="toctree-l3"><a class="reference internal" href="operations.ace_fitting.html">Fitting ACE</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="examples.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="examples.index.html">Index</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.dimers.html">Generating Dimer Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.buildcell.html">Random Structures via buildcell</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.orca_python.html">ORCA via Python script</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.fhiaims_calculator.html">FHI-Aims Calculator</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.mace.html">Parallelize MACE calculator</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.mlip_fitting.html">Iterative GAP fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.daisy_chain_mlip_fitting.html">GAP fit workflow with many wfl use-case examples</a></li>

<li class="toctree-l2"><a class="reference internal" href="examples.normal_modes.html">Normal Modes of molecules</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.smiles.html">SMILES to <code class="docutils literal notranslate"><span class="pre">Atoms</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.md.html">Molecular Dynamics</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.select_fps.html">Selection or Sampling of Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.contributions.html">Contributing Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="workflows.rss.html">GAP-RSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_line.automatic_docs.html">Command line interface</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="modules.html">Modules</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="wfl.html">wfl package</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="wfl.autoparallelize.html">wfl.autoparallelize package</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="wfl.calculators.html">wfl.calculators package</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="wfl.calculators.orca.html">wfl.calculators.orca package</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="wfl.cli.html">wfl.cli package</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="wfl.cli.commands.html">wfl.cli.commands package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="wfl.descriptors.html">wfl.descriptors package</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="wfl.fit.html">wfl.fit package</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="wfl.fit.gap.html">wfl.fit.gap package</a></li>
<li class="toctree-l4"><a class="reference internal" href="wfl.fit.modify_database.html">wfl.fit.modify_database package</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="wfl.generate.html">wfl.generate package</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="wfl.generate.md_PROTECT.html">wfl.generate.md package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="wfl.select.html">wfl.select package</a></li>
<li class="toctree-l3"><a class="reference internal" href="wfl.utils.html">wfl.utils package</a></li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/overview.parallelisation.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Automatic parallelization of tasks</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#programming-script-that-use-parallelized-operations">Programming script that use parallelized operations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mpi-with-wfl-mpipool">MPI with <code class="docutils literal notranslate"><span class="pre">WFL_MPIPOOL</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#runtime-control-over-parallelization">Runtime control over parallelization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#single-node-using-python-subprocesses">Single node using python subprocesses</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-nodes-using-mpi">Multiple nodes using MPI</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-auto-parallelized-functions">Creating auto-parallelized functions</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="section" id="automatic-parallelization-of-tasks">
<span id="parallelisation"></span><h1>Automatic parallelization of tasks<a class="headerlink" href="#automatic-parallelization-of-tasks" title="Permalink to this heading">#</a></h1>
<p>Much of the pipeline, including the input/output facilitated by <code class="docutils literal notranslate"><span class="pre">ConfigSet</span></code>/<code class="docutils literal notranslate"><span class="pre">OutputSpec</span></code>, was designed that so that simple operations that need to be done to many configurations could easily be parallelized.  The mechanism for that is wrapping the fundamental operations in a call to <code class="docutils literal notranslate"><span class="pre">wfl.autoparallelize.base.autoparallelize</span></code>. This parallelization can in principle include two levels</p>
<ul class="simple">
<li><p>Splitting up the input iterator into groups, each of which is processed by a separate
python subprocess.</p></li>
<li><p>Splitting up the input iterator into groups, each of which is processed in a separate
job submitted to a local or remote queuing system. The job can then use python
subprocess parallelization itself. [remote jobs not documented here yet]</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Autoparallelized operations will use cached output files.  Even if the code that is executed by
the operation has changed, the previous and perhaps wrong output will be used.
See warning in <a class="reference internal" href="overview.configset.html"><span class="doc">Input and output of atomic structures</span></a></p>
</div>
<div class="section" id="programming-script-that-use-parallelized-operations">
<h2>Programming script that use parallelized operations<a class="headerlink" href="#programming-script-that-use-parallelized-operations" title="Permalink to this heading">#</a></h2>
<p>Parallelized operations can be called from a python script, and have</p>
<ul class="simple">
<li><p>the first function argument is the inputs, as an iterator (usually <code class="docutils literal notranslate"><span class="pre">ConfigSet</span></code>, but some operations, e.g. <code class="docutils literal notranslate"><span class="pre">buildcell</span></code>,
just use a counter like <code class="docutils literal notranslate"><span class="pre">range(n)</span></code>).</p></li>
<li><p>The second function argument is outputs, as an <code class="docutils literal notranslate"><span class="pre">OutputSpec</span></code>. There is no support for returned values of any type other
than <code class="docutils literal notranslate"><span class="pre">Atoms</span></code> store in a <code class="docutils literal notranslate"><span class="pre">ConfigSet</span></code>.</p></li>
</ul>
<p>The function will return a <code class="docutils literal notranslate"><span class="pre">ConfigSet</span></code> containing the output configs, which will be stored wherever the <code class="docutils literal notranslate"><span class="pre">OutputSpec</span></code>
objectâ€™s constructor arguments indicated.</p>
<p>The optional argument <code class="docutils literal notranslate"><span class="pre">num_inputs_per_python_subprocess</span></code> will determine how many input values will
be procesed in each call to the low level function.  This defaults to 1, but can be increasd to reduce
overhead that happens once per call, e.g. the construction of expensive ASE calculators like <code class="docutils literal notranslate"><span class="pre">quippy.potential.Potential</span></code>
with a GAP model.</p>
<div class="section" id="mpi-with-wfl-mpipool">
<h3>MPI with <code class="docutils literal notranslate"><span class="pre">WFL_MPIPOOL</span></code><a class="headerlink" href="#mpi-with-wfl-mpipool" title="Permalink to this heading">#</a></h3>
<p>If it is necessary to parallelize over more than one node, <code class="docutils literal notranslate"><span class="pre">mpipool</span></code>
(see below) can be used. In this case (assuming that the script as a
whole is written for a single task/thread), at startup the script has
to call <code class="docutils literal notranslate"><span class="pre">wfl.autoparallelize.mpipool_support.init()</span></code>.  This function
will hang for every task except for <code class="docutils literal notranslate"><span class="pre">rank</span> <span class="pre">==</span> <span class="pre">0</span></code>, and all those tasks
will wait for things to be done through the <code class="docutils literal notranslate"><span class="pre">mpipool</span></code> mechanism.
Task 0 should continue, doing whatever it needs to, and when it calls
the wrapped operation it will be parallelized over all MPI tasks.</p>
</div>
</div>
<div class="section" id="runtime-control-over-parallelization">
<h2>Runtime control over parallelization<a class="headerlink" href="#runtime-control-over-parallelization" title="Permalink to this heading">#</a></h2>
<p>Once a function that operates on individual configs has been wrapped,
the user can get parallelization to happen in one of two different ways.</p>
<div class="section" id="single-node-using-python-subprocesses">
<h3>Single node using python subprocesses<a class="headerlink" href="#single-node-using-python-subprocesses" title="Permalink to this heading">#</a></h3>
<p>The first is using python threads,
created using <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool">multiprocessing.pool.Pool</a>.
The number of threads is controlled by an integer, passed in to the
function as an optional <code class="docutils literal notranslate"><span class="pre">num_python_subprocesses</span></code> argument, or stored
in the env var <code class="docutils literal notranslate"><span class="pre">WFL_NUM_PYTHON_SUBPROCESSES</span></code>.  The script should be
started with a normal run of the python executable.</p>
</div>
<div class="section" id="multiple-nodes-using-mpi">
<h3>Multiple nodes using MPI<a class="headerlink" href="#multiple-nodes-using-mpi" title="Permalink to this heading">#</a></h3>
<p>If using <code class="docutils literal notranslate"><span class="pre">mpipool</span></code> the env var <code class="docutils literal notranslate"><span class="pre">WFL_MPIPOOL</span></code> must be set to any value.
In this case  the script must be run with <code class="docutils literal notranslate"><span class="pre">mpirun</span></code> (or whatever is
appropriate for the installed MPI implementation), and the number of
python subprocesses will be determined by the number of <code class="docutils literal notranslate"><span class="pre">mpirun</span></code>
MPI tasks (e.g. <code class="docutils literal notranslate"><span class="pre">-np</span> <span class="pre">N</span></code>).  All MPI tasks will be used to parallelize
using <a class="reference external" href="https://mpi4py.readthedocs.io/en/stable/">mpi4py</a> and
<a class="reference external" href="https://github.com/mpipool/mpipool">mpipool</a>.</p>
</div>
</div>
<div class="section" id="creating-auto-parallelized-functions">
<h2>Creating auto-parallelized functions<a class="headerlink" href="#creating-auto-parallelized-functions" title="Permalink to this heading">#</a></h2>
<p>To code an operation that can be parallelized over configuration (or
any other iterable), it needs to be implemented as a function that
takes, normally as its first argument, an <strong>iterable</strong>, e.g. a list of
<code class="docutils literal notranslate"><span class="pre">ase.atoms.Atoms</span></code>, and returns a <strong>list</strong> of <code class="docutils literal notranslate"><span class="pre">ase.atoms.Atoms</span></code>
of the same length.  Input can be any iterable, but output must be
<code class="docutils literal notranslate"><span class="pre">Atoms</span></code> or nothing, no other objects.  If the actual work is being
done in a function called <code class="docutils literal notranslate"><span class="pre">op</span></code>, it should be defined as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">op</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">arg3</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
    <span class="n">output_ats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="o">&lt;</span><span class="n">do</span> <span class="n">some</span> <span class="n">stuff</span> <span class="k">with</span> <span class="n">at</span> <span class="ow">and</span> <span class="n">argN</span><span class="o">&gt;</span>
        <span class="n">output_ats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_ats</span>
</pre></div>
</div>
<p>An auto-parallelized wrapper function can then be defined as (for example)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">autopara_op</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">autoparallelize</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">def_num_inputs_per_python_subprocess</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">autopara_op</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">autoparallelize_docstring</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">__foc__</span><span class="p">,</span> <span class="s2">&quot;Atoms&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">def_num_inputs_per_python_subprocess</span></code> controls how many items
(by default) from the input iterable are passed to each call of
<code class="docutils literal notranslate"><span class="pre">op()</span></code> (to reduce startup overhead).  All arguments <em>must be</em>
pickleable.  If something that cannot be pickled must be passed (e.g. a
<code class="docutils literal notranslate"><span class="pre">quippy.potential.Potential</span></code>), it must be passed in some way, e.g. a
constructor function and its arguments, that _can_ be pickled (see <code class="docutils literal notranslate"><span class="pre">wfl.calculators.generic</span></code>).  For things
that need to happen once per thread, e.g. random number initialization,
there is an <code class="docutils literal notranslate"><span class="pre">initializer</span></code> argument to <code class="docutils literal notranslate"><span class="pre">autoparallelize()</span></code> (see <code class="docutils literal notranslate"><span class="pre">wfl.generate.md</span></code>).</p>
<p>There are many examples of this, including the descriptor calculator, and (with initializers) md and minim.</p>
</div>
</div>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="overview.configset.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Input and output of atomic structures</p>
      </div>
    </a>
    <a class="right-next"
       href="overview.queued.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Functions as independently queued jobs</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#programming-script-that-use-parallelized-operations">Programming script that use parallelized operations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mpi-with-wfl-mpipool">MPI with <code class="docutils literal notranslate"><span class="pre">WFL_MPIPOOL</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#runtime-control-over-parallelization">Runtime control over parallelization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#single-node-using-python-subprocesses">Single node using python subprocesses</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-nodes-using-mpi">Multiple nodes using MPI</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-auto-parallelized-functions">Creating auto-parallelized functions</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By N. Bernstein, T. K. Stenczel, E. Gelzinyte
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>